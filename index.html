<script>
let cash = 100000;
let portfolio = {};

/* =========================
   REALISTIC HISTORY GENERATOR
========================= */
function generateHistory(startPrice, points = 80) {
  let history = [];
  let price = startPrice;

  for (let i = 0; i < points; i++) {
    let change = (Math.random() * 3 - 1.5); // -1.5% to +1.5%
    price *= 1 + change / 100;
    history.push(price);
  }
  return history;
}

/* =========================
   STOCK DATA
========================= */
let stocks = [
  { ticker:"NXAI", name:"Nexora AI", price:142, history:generateHistory(142) },
  { ticker:"BLKW", name:"Blackwave Industries", price:87, history:generateHistory(87) },
  { ticker:"VRTX", name:"Vertex Dynamics", price:59, history:generateHistory(59) },
  { ticker:"OMNI", name:"OmniCore Systems", price:212, history:generateHistory(212) },
  { ticker:"CYBR", name:"Cyberion Security", price:134, history:generateHistory(134) },
  { ticker:"AETH", name:"Aether Energy", price:73, history:generateHistory(73) }
];

const ctx = document.getElementById("chart").getContext("2d");

/* =========================
   RENDER STOCK TABLE
========================= */
function renderStocks(){
  const container = document.getElementById("stocks");
  container.innerHTML = "";

  stocks.forEach(stock => {

    let change = (Math.random() * 4 - 2); // -2% to +2%
    stock.price *= 1 + change / 100;

    stock.history.push(stock.price);
    if (stock.history.length > 120) stock.history.shift();

    container.innerHTML += `
    <div class="row" onclick="openModal('${stock.ticker}')">
      <div>${stock.ticker} <span style="color:gray;font-size:12px">${stock.name}</span></div>
      <div>$${stock.price.toFixed(2)}</div>
      <div class="${change >= 0 ? 'green':'red'}">${change.toFixed(2)}%</div>
      <div><input type="number" min="1" value="1" id="qty-${stock.ticker}"></div>
      <div><button class="buy" onclick="event.stopPropagation();buy('${stock.ticker}')">Buy</button></div>
      <div><button class="sell" onclick="event.stopPropagation();sell('${stock.ticker}')">Sell</button></div>
    </div>`;
  });
}

/* =========================
   BUY / SELL
========================= */
function buy(ticker){
  let stock = stocks.find(s => s.ticker === ticker);
  let qty = +document.getElementById("qty-" + ticker).value;
  let cost = stock.price * qty;

  if(cost > cash) return alert("Not enough cash");

  cash -= cost;
  portfolio[ticker] = portfolio[ticker] || { shares:0, cost:0 };
  portfolio[ticker].shares += qty;
  portfolio[ticker].cost += cost;

  updateUI();
}

function sell(ticker){
  if(!portfolio[ticker]) return;

  let stock = stocks.find(s => s.ticker === ticker);
  let qty = +document.getElementById("qty-" + ticker).value;

  if(qty > portfolio[ticker].shares) return alert("Not enough shares");

  cash += stock.price * qty;
  portfolio[ticker].shares -= qty;

  let avgCost = portfolio[ticker].cost / (portfolio[ticker].shares + qty);
  portfolio[ticker].cost -= avgCost * qty;

  if(portfolio[ticker].shares === 0) delete portfolio[ticker];

  updateUI();
}

/* =========================
   PORTFOLIO UPDATE
========================= */
function updateUI(){
  document.getElementById("cash").innerText = cash.toFixed(2);

  let p = document.getElementById("portfolio");
  p.innerHTML = "";

  let totalValue = 0;
  let totalCost = 0;

  for(let t in portfolio){
    let stock = stocks.find(s => s.ticker === t);
    let value = stock.price * portfolio[t].shares;
    let pl = value - portfolio[t].cost;

    totalValue += value;
    totalCost += portfolio[t].cost;

    p.innerHTML += `
    <div class="row">
      <div>${t}</div>
      <div>${portfolio[t].shares}</div>
      <div>$${(portfolio[t].cost / portfolio[t].shares).toFixed(2)}</div>
      <div>$${stock.price.toFixed(2)}</div>
      <div>$${value.toFixed(2)}</div>
      <div class="${pl >= 0 ? 'green':'red'}">$${pl.toFixed(2)}</div>
    </div>`;
  }

  document.getElementById("value").innerText = totalValue.toFixed(2);
  let totalPL = totalValue - totalCost;
  document.getElementById("pl").innerHTML =
    `<span class="${totalPL >= 0 ? 'green':'red'}">$${totalPL.toFixed(2)}</span>`;
}

/* =========================
   MODAL + CHART
========================= */
function openModal(ticker){
  let stock = stocks.find(s => s.ticker === ticker);
  document.getElementById("modalTitle").innerText =
    `${stock.ticker} â€” ${stock.name}`;

  document.getElementById("modal").style.display = "flex";
  drawChart(stock.history);
}

function closeModal(){
  document.getElementById("modal").style.display = "none";
}

function drawChart(data){
  const width = 700;
  const height = 300;

  ctx.clearRect(0,0,width,height);

  let min = Math.min(...data);
  let max = Math.max(...data);
  let range = max - min;

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#22c55e";
  ctx.beginPath();

  data.forEach((price, i) => {
    let x = i * (width / data.length);
    let y = height - ((price - min) / range) * (height - 40) - 20;

    if(i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });

  ctx.stroke();
}

/* =========================
   AUTO UPDATE LOOP
========================= */
setInterval(() => {
  renderStocks();
  updateUI();
}, 3000);

renderStocks();
updateUI();
</script>
