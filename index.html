<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Avancerat Tropiskt Ö-Byggarspel</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #222; }
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; color: white; display: flex;
            justify-content: center; align-items: center; font-size: 2em;
            z-index: 1000; transition: opacity 1s ease-out;
        }
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 999;
        }
        #game-ui {
            position: absolute; top: 10px; left: 10px; color: white;
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px;
            display: none; flex-direction: column; gap: 10px; z-index: 998;
        }
        #game-ui h1 { margin-top: 0; font-size: 1.8em; }
        #game-ui button, #menu-screen button {
            background-color: #4CAF50; color: white; padding: 12px 20px;
            border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em;
            transition: background-color 0.3s ease; margin: 5px;
        }
        #game-ui button:hover, #menu-screen button:hover { background-color: #45a049; }
        .resource-display {
            display: flex; align-items: center; gap: 5px; font-size: 1.1em;
        }
        .resource-icon { width: 24px; height: 24px; background-color: grey; border-radius: 3px; } /* Platshållare */
        #build-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        #build-buttons button { background-color: #007bff; }
        #build-buttons button.active { background-color: #0056b3; border: 2px solid white; }
    </style>
</head>
<body>

    <div id="loading-screen">Laddar spelvärlden...</div>

    <div id="menu-screen">
        <h1>Välkommen till Ö-Byggaren!</h1>
        <p>Välj din ö-typ:</p>
        <button id="btn-tropical">Tropisk Ö</button>
        <button id="btn-rocky">Klippig Ö</button>
        <button id="btn-volcano">Vulkan-Ö</button>
    </div>

    <div id="game-ui">
        <h1>Min Ö</h1>
        <div class="resource-display"><span class="resource-icon" style="background-color: brown;"></span> Trä: <span id="resource-wood">0</span></div>
        <div class="resource-display"><span class="resource-icon" style="background-color: lightgray;"></span> Sten: <span id="resource-stone">0</span></div>
        <div class="resource-display"><span class="resource-icon" style="background-color: goldenrod;"></span> Guld: <span id="resource-gold">0</span></div>

        <div id="build-buttons">
            <button id="build-tree" data-cost-wood="10" data-cost-stone="0" data-model="tree">Plantera Träd (10 Trä)</button>
            <button id="build-house" data-cost-wood="20" data-cost-stone="10" data-model="house">Bygg Hus (20 Trä, 10 Sten)</button>
            <button id="build-mine" data-cost-wood="15" data-cost-stone="20" data-model="mine">Bygg Gruva (15 Trä, 20 Sten)</button>
        </div>
        <p>Klicka på ön för att placera!</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- GLOBAL VARIABLES ---
        let scene, camera, renderer, controls;
        let islandMesh, waterMesh;
        let raycaster, mouse;
        let currentlyBuilding = null; // Stores the type of object to build (e.g., 'tree', 'house')
        let resources = { wood: 0, stone: 0, gold: 0 };
        const MODELS = {}; // Store loaded GLTF models
        const MODEL_PATHS = {
            tree: 'assets/models/tree.glb', // Replace with your actual tree model
            house: 'assets/models/house.glb', // Replace with your actual house model
            mine: 'assets/models/mine.glb' // Replace with your actual mine model
        };
        const TEXTURE_PATHS = {
            sand: 'assets/textures/sand_diffuse.jpg', // https://threejs.org/examples/textures/terrain/desert.jpg
            rock: 'assets/textures/rock_diffuse.jpg', // https://threejs.org/examples/textures/lava/web_lava_diffuse.jpg
            grass: 'assets/textures/grass_diffuse.jpg', // https://threejs.org/examples/textures/terrain/grass.jpg
            height_tropical: 'assets/textures/heightmap_tropical.png', // https://threejs.org/examples/textures/heightmap_1.png
            height_rocky: 'assets/textures/heightmap_rocky.png',
            height_volcano: 'assets/textures/heightmap_volcano.png'
        };

        // --- UI ELEMENTS ---
        const loadingScreen = document.getElementById('loading-screen');
        const menuScreen = document.getElementById('menu-screen');
        const gameUI = document.getElementById('game-ui');
        const resourceWood = document.getElementById('resource-wood');
        const resourceStone = document.getElementById('resource-stone');
        const resourceGold = document.getElementById('resource-gold');
        const buildButtons = document.getElementById('build-buttons');

        // --- AUDIO ---
        let backgroundMusic;

        // --- INITIAL SETUP (AFTER ALL ASSETS ARE LOADED) ---
        async function init(islandType) {
            // Hide loading, show game UI
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.style.display = 'none', 1000);
            gameUI.style.display = 'flex';
            
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky Blue

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(20, 30, 20); // Elevated view
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true; // Enable shadows
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, 0);
            controls.maxDistance = 60;
            controls.minDistance = 5;
            controls.maxPolarAngle = Math.PI / 2.2; // Prevent camera from going under island

            // Lighting
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(50, 100, 50);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048;
            sun.shadow.mapSize.height = 2048;
            sun.shadow.camera.near = 0.5;
            sun.shadow.camera.far = 200;
            sun.shadow.camera.left = -50;
            sun.shadow.camera.right = 50;
            sun.shadow.camera.top = 50;
            sun.shadow.camera.bottom = -50;
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x404040, 0.5)); // Soft ambient light

            // Water
            const waterGeometry = new THREE.PlaneGeometry(200, 200, 10, 10);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x0077be, // Deep ocean blue
                transparent: true,
                opacity: 0.7,
                roughness: 0.5,
                metalness: 0.5
            });
            waterMesh = new THREE.Mesh(waterGeometry, waterMaterial);
            waterMesh.rotation.x = -Math.PI / 2;
            waterMesh.position.y = -0.5; // Slightly below island base
            scene.add(waterMesh);

            // Island Generation
            await generateIsland(islandType);

            // Raycasting for building
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('click', onCanvasClick);

            // Start animation
            animate();

            // Play background music
            if (backgroundMusic) {
                backgroundMusic.play();
                backgroundMusic.loop = true;
                backgroundMusic.volume = 0.3;
            }

            // Initial resources
            addResources({ wood: 100, stone: 50, gold: 0 }); // Starting resources
        }

        // --- ISLAND GENERATION ---
        async function generateIsland(type) {
            let texturePath, heightmapPath;
            let baseColor, topColor; // For vertex colors or more complex materials

            switch (type) {
                case 'tropical':
                    texturePath = TEXTURE_PATHS.sand;
                    heightmapPath = TEXTURE_PATHS.height_tropical;
                    baseColor = new THREE.Color(0x228B22); // Green
                    topColor = new THREE.Color(0xF4A460);  // Sandy
                    break;
                case 'rocky':
                    texturePath = TEXTURE_PATHS.rock;
                    heightmapPath = TEXTURE_PATHS.height_rocky;
                    baseColor = new THREE.Color(0x333333); // Dark rock
                    topColor = new THREE.Color(0x888888);  // Grey rock
                    break;
                case 'volcano':
                    texturePath = TEXTURE_PATHS.rock; // Lava/dark rock
                    heightmapPath = TEXTURE_PATHS.height_volcano;
                    baseColor = new THREE.Color(0x8B0000); // Dark Red/Brown lava
                    topColor = new THREE.Color(0x222222);  // Black rock
                    break;
                default: // Fallback
                    texturePath = TEXTURE_PATHS.sand;
                    heightmapPath = TEXTURE_PATHS.height_tropical;
                    baseColor = new THREE.Color(0x228B22);
                    topColor = new THREE.Color(0xF4A460);
            }

            const islandSize = 50;
            const segments = 128; // Higher segments for more detail
            const islandGeometry = new THREE.CylinderGeometry(islandSize, islandSize * 0.8, 10, segments, 1, false);
            const textureLoader = new THREE.TextureLoader();

            let heightmap;
            try {
                heightmap = await textureLoader.loadAsync(heightmapPath);
            } catch (error) {
                console.error("Failed to load heightmap:", heightmapPath, error);
                // Fallback if heightmap fails
                heightmap = new THREE.Texture(new ImageData(new Uint8ClampedArray(256 * 256 * 4).fill(128), 256, 256));
                heightmap.needsUpdate = true;
            }
            
            // Apply heightmap to geometry
            const img = heightmap.image;
            if (img && img.width && img.height) {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, img.width, img.height).data;

                const positions = islandGeometry.attributes.position.array;
                const vertexCount = positions.length / 3;

                for (let i = 0; i < vertexCount; i++) {
                    const x = positions[i * 3];
                    const z = positions[i * 3 + 2];

                    // Map x, z to 0-1 range for texture lookup
                    let u = (x / islandSize / 2) + 0.5;
                    let v = (z / islandSize / 2) + 0.5;

                    u = Math.min(1, Math.max(0, u));
                    v = Math.min(1, Math.max(0, v));

                    const pixelX = Math.floor(u * (img.width - 1));
                    const pixelY = Math.floor(v * (img.height - 1));
                    const pixelIndex = (pixelY * img.width + pixelX) * 4;
                    const heightValue = imageData[pixelIndex] / 255; // Red channel for height
                    
                    // Apply height deformation, adjust strength
                    positions[i * 3 + 1] += (heightValue - 0.5) * 8; // Adjust multiplier for height scale
                }
                islandGeometry.attributes.position.needsUpdate = true;
                islandGeometry.computeVertexNormals(); // Recalculate normals for correct lighting
            }

            const islandMaterial = new THREE.MeshStandardMaterial({
                map: await textureLoader.loadAsync(texturePath), 
                roughness: 0.8,
                metalness: 0.1
            });
            
            islandMesh = new THREE.Mesh(islandGeometry, islandMaterial);
            islandMesh.receiveShadow = true;
            islandMesh.castShadow = true;
            islandMesh.position.y = -2; // Slightly sunken into the water
            scene.add(islandMesh);

            // Add some initial objects based on island type
            addResources({ wood: 50, stone: 20, gold: 0 }); // Give some initial resources
            for (let i = 0; i < 5; i++) {
                placeRandomObject(MODELS.tree, islandMesh, 0.5); // Place some initial trees
            }
        }

        // --- RESOURCE & UI MANAGEMENT ---
        function updateResourcesUI() {
            resourceWood.textContent = resources.wood;
            resourceStone.textContent = resources.stone;
            resourceGold.textContent = resources.gold;

            // Update build button states
            buildButtons.querySelectorAll('button').forEach(button => {
                const costWood = parseInt(button.dataset.costWood);
                const costStone = parseInt(button.dataset.costStone);
                button.disabled = resources.wood < costWood || resources.stone < costStone;
            });
